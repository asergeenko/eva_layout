#!/usr/bin/env python3
"""Test AUDI A6 (C7) 4 DXF search functionality."""

import os
import re

def test_audi_a6_search():
    """Test the search for AUDI A6 (C7) 4 DXF files."""
    print("üöó –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞ DXF —Ñ–∞–π–ª–æ–≤ –¥–ª—è AUDI A6 (C7) 4")
    print("=" * 60)
    
    # Test data from Excel analysis
    article = "EVA_BORT+Audi+A6+2011-2018+black+12"
    product_name = "AUDI A6 (C7) 4"
    
    print(f"üìã –ê—Ä—Ç–∏–∫—É–ª: {article}")
    print(f"üè∑Ô∏è –¢–æ–≤–∞—Ä: {product_name}")
    print()
    
    # Simulate the improved search logic
    def search_by_product_name(product_name):
        """Search by product name logic."""
        found_files = []
        
        # Extract brand and model from product name
        product_upper = product_name.upper()
        
        # Handle common brand name mappings
        brand_mapping = {
            'AUDI': 'AUDI',
            'BMW': 'BMW',
            'MERCEDES': 'MERCEDES',
            'VOLKSWAGEN': 'VOLKSWAGEN',
            'FORD': 'FORD',
            'TOYOTA': 'TOYOTA',
            'NISSAN': 'NISSAN',
            'HYUNDAI': 'HYUNDAI',
            'KIA': 'KIA',
            'CHERY': 'CHERY',
            'CHANGAN': 'CHANGAN'
        }
        
        # Find brand in product name
        detected_brand = None
        for brand_key, brand_folder in brand_mapping.items():
            if brand_key in product_upper:
                detected_brand = brand_folder
                break
        
        print(f"üîç –û–ø—Ä–µ–¥–µ–ª—ë–Ω –±—Ä–µ–Ω–¥: {detected_brand}")
        
        if detected_brand:
            brand_path = f"dxf_samples/{detected_brand}"
            if os.path.exists(brand_path):
                print(f"‚úÖ –ü–∞–ø–∫–∞ –±—Ä–µ–Ω–¥–∞ –Ω–∞–π–¥–µ–Ω–∞: {brand_path}")
                
                # Create search keywords from product name
                product_keywords = []
                
                # Clean product name and extract model parts
                model_part = product_upper.replace(detected_brand, '').strip()
                print(f"üìù –ú–æ–¥–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å: '{model_part}'")
                
                # Add full product name as keyword
                product_keywords.append(product_name.lower())
                
                # Handle parentheses and extract parts
                if '(' in model_part and ')' in model_part:
                    parentheses_content = re.findall(r'\((.*?)\)', model_part)
                    base_model = re.sub(r'\s*\([^)]*\)\s*', ' ', model_part).strip()
                    
                    print(f"üîñ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–±–æ–∫: {parentheses_content}")
                    print(f"üîñ –ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å: '{base_model}'")
                    
                    product_keywords.extend([
                        base_model.lower(),
                        model_part.replace('(', '').replace(')', '').lower(),
                    ])
                    
                    for content in parentheses_content:
                        product_keywords.extend([
                            content.lower(),
                            f"{base_model} {content}".lower(),
                        ])
                
                # Extract individual parts
                model_parts = re.sub(r'[^\w\s]', ' ', model_part).split()
                product_keywords.extend([part.lower() for part in model_parts if len(part) > 1])
                
                # Remove duplicates
                product_keywords = list(set([k.strip() for k in product_keywords if k.strip()]))
                
                print(f"üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:")
                for kw in sorted(product_keywords):
                    print(f"   ‚Ä¢ '{kw}'")
                print()
                
                # Search through brand folders
                print(f"üìÅ –ü–æ–∏—Å–∫ –≤ –ø–∞–ø–∫–∞—Ö –±—Ä–µ–Ω–¥–∞:")
                folders_found = []
                
                for model_folder in os.listdir(brand_path):
                    model_folder_path = os.path.join(brand_path, model_folder)
                    if os.path.isdir(model_folder_path):
                        folder_name_lower = model_folder.lower()
                        
                        # Calculate match score with Cyrillic/Latin normalization
                        match_score = 0
                        matched_keywords = []
                        
                        # Normalize folder name for better matching (handle Cyrillic/Latin)
                        normalized_folder = folder_name_lower
                        # Replace common Cyrillic letters with Latin equivalents
                        cyrillic_to_latin = {
                            '–∞': 'a', '–ê': 'A',
                            '—Å': 'c', '–°': 'C',
                            '–µ': 'e', '–ï': 'E',
                            '–æ': 'o', '–û': 'O',
                            '—Ä': 'p', '–†': 'P',
                            '—Ö': 'x', '–•': 'X'
                        }
                        for cyrillic, latin in cyrillic_to_latin.items():
                            normalized_folder = normalized_folder.replace(cyrillic, latin)
                        
                        print(f"      –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∏–º—è: '{normalized_folder}'")
                        
                        for keyword in product_keywords:
                            if keyword and len(keyword) > 2:
                                # Direct match in normalized folder name
                                if keyword in normalized_folder:
                                    score_add = len(keyword) * 2
                                    match_score += score_add
                                    matched_keywords.append(f"'{keyword}' –≤ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º (+{score_add})")
                                # Direct match in original folder name
                                elif keyword in folder_name_lower:
                                    score_add = len(keyword) * 2
                                    match_score += score_add
                                    matched_keywords.append(f"'{keyword}' (+{score_add})")
                                else:
                                    # Check partial matches in normalized folder
                                    keyword_parts = keyword.split()
                                    matched_parts = sum(1 for part in keyword_parts 
                                                      if part in normalized_folder or part in folder_name_lower)
                                    if matched_parts > 0:
                                        score_add = matched_parts * 3
                                        match_score += score_add
                                        matched_keywords.append(f"'{keyword}' —á–∞—Å—Ç–∏—á–Ω–æ (+{score_add})")
                        
                        print(f"   üìÇ {model_folder}")
                        print(f"      –û—Ü–µ–Ω–∫–∞: {match_score}")
                        if matched_keywords:
                            print(f"      –°–æ–≤–ø–∞–¥–µ–Ω–∏—è: {', '.join(matched_keywords)}")
                        
                        # If we have a good match, look for DXF files
                        if match_score >= 6:  # Threshold for product name matching
                            print(f"      ‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–∞—è –æ—Ü–µ–Ω–∫–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ DXF —Ñ–∞–π–ª–æ–≤!")
                            
                            dxf_folder = os.path.join(model_folder_path, "DXF")
                            if os.path.exists(dxf_folder):
                                dxf_files_found = [f for f in os.listdir(dxf_folder) if f.lower().endswith('.dxf')]
                                print(f"      üìÑ –ù–∞–π–¥–µ–Ω–æ DXF —Ñ–∞–π–ª–æ–≤: {len(dxf_files_found)}")
                                for dxf_file in dxf_files_found:
                                    full_path = os.path.join(dxf_folder, dxf_file)
                                    found_files.append(full_path)
                                    print(f"         ‚Ä¢ {dxf_file}")
                                if found_files:
                                    folders_found.append(model_folder)
                                    break
                            else:
                                # Check for DXF files directly in model folder
                                dxf_files_found = [f for f in os.listdir(model_folder_path) if f.lower().endswith('.dxf')]
                                if dxf_files_found:
                                    print(f"      üìÑ –ù–∞–π–¥–µ–Ω–æ DXF —Ñ–∞–π–ª–æ–≤ (–ø—Ä—è–º–æ –≤ –ø–∞–ø–∫–µ): {len(dxf_files_found)}")
                                    for dxf_file in dxf_files_found:
                                        full_path = os.path.join(model_folder_path, dxf_file)
                                        found_files.append(full_path)
                                        print(f"         ‚Ä¢ {dxf_file}")
                                    folders_found.append(model_folder)
                                    break
                        print()
                
                if folders_found:
                    print(f"üéâ –ù–∞–π–¥–µ–Ω—ã –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–∞–ø–∫–∏: {', '.join(folders_found)}")
                else:
                    print("‚ùå –ü–æ–¥—Ö–æ–¥—è—â–∏–µ –ø–∞–ø–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
                    
            else:
                print(f"‚ùå –ü–∞–ø–∫–∞ –±—Ä–µ–Ω–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {brand_path}")
        
        return found_files
    
    # Run the test
    found_files = search_by_product_name(product_name)
    
    print(f"\nüìä –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞:")
    if found_files:
        print(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ {len(found_files)} DXF —Ñ–∞–π–ª–æ–≤:")
        for file_path in found_files:
            print(f"   üìÑ {file_path}")
    else:
        print("‚ùå DXF —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    
    print(f"\nüéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ:")
    if found_files:
        print("‚úÖ –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –ø–æ–∏—Å–∫–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é —Ç–æ–≤–∞—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!")
        print("‚úÖ AUDI A6 (C7) 4 —Ç–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –Ω–∞–π–¥–µ–Ω–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏!")
    else:
        print("‚ùå –¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–ª–≥–æ—Ä–∏—Ç–º–∞ –ø–æ–∏—Å–∫–∞")
    
    return len(found_files) > 0

if __name__ == "__main__":
    success = test_audi_a6_search()
    print(f"\n{'üéâ –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω!' if success else '‚ùå –¢–µ—Å—Ç –Ω–µ –ø—Ä–æ–π–¥–µ–Ω!'}")